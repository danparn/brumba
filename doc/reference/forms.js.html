<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: forms.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: forms.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Brumba
 * Copyright (c) 2012-2020 Dan Parnete
 *
 * This source code is licensed under the MIT license.
*/

import { toJSON, strSplit, objEmpty } from './common'
import { br } from './util'
import { formRetrieve, formUpdate } from './form'

let forms = []
export const formsInit = () => {forms = []}


/* 
 *  Add new form
 */
export const addForm = formE => {
	const name = formE.getAttribute('name')
	const	form = {
	  name: name,
	  query: toJSON(mainArgs(formE.getAttribute('data-query'))),
	  list: formE.getAttribute('data-list')
	}
	const i = forms.findIndex(f => f.name === name)
	if (i &lt; 0) {
		forms.push(form)
	} else {
		forms[i] = form
	}
	setMaster(form)
	return form
}




/* 
 *  Add new grid
 */
export const addGrid = grid => {
	if (!findForm(grid.name)) {
		forms.push(grid)
		setMaster(grid)
	}
}




/**
 *  Find form
 * &lt;br>Form = {
 * &lt;br>&lt;ul>&lt;ui>name: 'fname',
 * &lt;br>&lt;ui>query: {coll: 'cname', fields: 'fld1,fld2', where: {}, sort: {field:1}},
 * &lt;br>&lt;ui>list: string,
 * &lt;br>&lt;ui>fields: [{
 * &lt;br>&lt;ul>&lt;ui>name: string,
 * &lt;br>&lt;ui>type: string,
 * &lt;br>&lt;ui>newval: val
 * &lt;br>&lt;/ul>},...]
 * &lt;br>&lt;ui>data: {},
 * &lt;br>&lt;ui>modified: false
 * &lt;br>&lt;/ul>}
 * @function
 * @param {string|object} arg
 * @returns {object} form
 */
export const findForm = arg => {
	if (!arg) return null
	
	if (typeof arg !== 'string') {
		arg = arg.getAttribute('name')
	}
	return forms.find(f => f.name === arg)
}



/* 
 *  Get details
 */
export const getDetails = form => {
	let det = []
	if (form) {
		forms.forEach(f => {
			if (f.master === form) {
				det.push(f)
			}
		})
	}
	return det
}



/* 
 *  Find list form
 */
export const listForm = () => {
	return forms.find(f => f.list &amp;&amp; f.query &amp;&amp; f.query.coll &amp;&amp; !f.query.findone)
}



/* 
 *  Set form's master
 */
export const setMaster = form => {
	if (form &amp;&amp; form.query &amp;&amp; !form.query.coll &amp;&amp; !form.master) {
		const field = form.query.field || form.query.concat
		
		if (form.query.master) {
			form.master = findForm(form.query.master)
			delete form.query.master			
		
		} else if (field) {
			const p = field.lastIndexOf('.')
			if (p > 0) {
				const coll = field.substring(0, p)
				forms.forEach(f => {
					let fc = f.query.field
					if (f.query.concat) {
						if (f.query.coll) {
							fc = f.query.coll + '.' + f.query.concat
						} else {
							fc = f.query.concat
						}
					}
					if (f.query &amp;&amp; (f.query.coll === coll || fc === coll)) {
						form.master = f
						return
					}
				})
			}
		
		} else if (objEmpty(form.query)) {
			form.master = listForm()
		}
	}
//console.log(`form: ${form.name}  master: ${form.master ? form.master.name : 'null'}`)
}




/* 
 *  Refresh forms
 */
export const refreshForms = () => {
	forms.filter(r => r.query.coll || r.query.script).forEach(f => {
		if (f.columns) {
			f.externRefresh()
		} else if (f.data &amp;&amp; f.data._id) {
			formRetrieve(f, f.data._id)
		} else {
			formUpdate(f, {})
		}
	})
}




/* 
 * Replace main arguments
 */
export const mainArgs = str => {
	if (str) {
		let qs = str.replace('$user', br.user)
		const uid = isNaN(br.userid) ? '"'+br.userid+'"' : br.userid
		qs = qs.replace('$userid', uid)
		if (br.menuid) {
			qs = qs.replace('$menuid', br.menuid)
		}
		qs = qs.replace('$menuarg', br.menuarg || '_id')
		return qs
	}
}


</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#$">$</a></li><li><a href="global.html#$$">$$</a></li><li><a href="global.html#br">br</a></li><li><a href="global.html#childIndex">childIndex</a></li><li><a href="global.html#clientScript">clientScript</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#e$">e$</a></li><li><a href="global.html#e$$">e$$</a></li><li><a href="global.html#err">err</a></li><li><a href="global.html#findForm">findForm</a></li><li><a href="global.html#formInput">formInput</a></li><li><a href="global.html#formRetrieve">formRetrieve</a></li><li><a href="global.html#formSave">formSave</a></li><li><a href="global.html#formUpdate">formUpdate</a></li><li><a href="global.html#gridRender">gridRender</a></li><li><a href="global.html#hex24">hex24</a></li><li><a href="global.html#inputDate">inputDate</a></li><li><a href="global.html#n$$">n$$</a></li><li><a href="global.html#objClone">objClone</a></li><li><a href="global.html#objDel">objDel</a></li><li><a href="global.html#objEmpty">objEmpty</a></li><li><a href="global.html#objLess">objLess</a></li><li><a href="global.html#objPick">objPick</a></li><li><a href="global.html#remote">remote</a></li><li><a href="global.html#report">report</a></li><li><a href="global.html#strCap">strCap</a></li><li><a href="global.html#strFindAny">strFindAny</a></li><li><a href="global.html#strGetBet">strGetBet</a></li><li><a href="global.html#strSplit">strSplit</a></li><li><a href="global.html#timezone">timezone</a></li><li><a href="global.html#toJSON">toJSON</a></li><li><a href="global.html#translate">translate</a></li><li><a href="global.html#validate">validate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Sun Aug 16 2020 11:54:32 GMT+0300 (Eastern European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
