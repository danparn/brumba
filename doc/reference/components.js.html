<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*
 * Brumba
 * Copyright (c) 2012-2020 Dan Parnete
 *
 * This source code is licensed under the MIT license.
*/

import { render } from 'web/inferno';
import MetisMenu from 'web/metismenujs'
import { objLess, translate, toJSON, strSplit } from './common'
import { Message } from "./inferno-bulma"
import { $, e$, br, remote, modified, createElement } from './util'
import { findForm } from './forms'




/* 
 *  Render to string
 */
export const renderToString = (jsx) => {
	const div = createElement('&lt;div>&lt;/div>')
	render(jsx, div)
	return div.innerHTML
}



/* 
 *  Navbar
 */
export const Navbar = (props) => {
  const openSidebar = () => $("#br-sidebar").style.width = "300px"
  
  return (
    &lt;nav>
      &lt;div class="br-navbar">
        &lt;a title="menu" class="br-bars" onClick={openSidebar}>&lt;i class="fa fa-bars">&lt;/i>&lt;/a>
        {props.children}
      &lt;/div>
    &lt;/nav>
  )
}




/* 
 *  Sidebar
 */
export const Sidebar = (props) => {
  const closeSidebar = () => $("#br-sidebar").style.width = "0px"
  
  return (
    &lt;nav class="sidebar-nav" id="br-sidebar">
      &lt;a class="closebtn" onclick={closeSidebar}>&amp;times;&lt;/a>
      &lt;ul class="metismenu" id="br-menu">
        {props.children}
      &lt;/ul>
    &lt;/nav>
  )
}

Sidebar.defaultHooks = {
  onComponentDidMount() {
    new MetisMenu("#br-menu")
  }
}

export const closeSidebar = () => {
  $('#br-sidebar').style.width = "0px"
  const el = $('#br-menu a.active')
  if (el) el.classList.remove('active')   // deactivate
  const cm = $('.CodeMirror')
  if (cm) cm.CodeMirror.toTextArea()
  render(null, br.ws)
  const wo = br.wo
  if (wo) {
    wo.removeAttribute('id')
    wo.name = ''
    wo.value = ''  
  }
}
  



/* 
 *  Dialog
 */
export const Dialog = (props) => {
  return (
    &lt;Message {...props} onClose={closeDialog} />
  )
}

Dialog.defaultHooks = {
  onComponentDidMount(domNode) {
    const header = domNode.getElementsByClassName('message-header')[0]
    const dialog = domNode.parentNode
    header.draggable = true
    let offsetX, offsetY, pageX, pageY, screenX, screenY
    
    header.addEventListener("dragstart", e => {
      offsetX = e.offsetX
      offsetY = e.offsetY
      pageX = e.pageX
      pageY = e.pageY
      screenX = e.screenX
      screenY = e.screenY
    }, false)
    
    header.addEventListener("dragover", e => {
			e.preventDefault()
    }, false)
    
    header.addEventListener("dragend", e => {
			e.preventDefault()
      dialog.style.left = pageX + (e.screenX - screenX) - offsetX + 'px'
      dialog.style.top = pageY + (e.screenY - screenY) - offsetY + 'px'
    }, false)
  }
}

export const closeDialog = (e) => {
  const dlg = br.dlg
  // remenber pos
  const art = dlg.firstChild
  if (localStorage &amp;&amp; art) {
    let pos = {top: dlg.style.top, left: dlg.style.left}
    if (art.className.includes('br-props')) {
      localStorage.setItem('br.dialogPos.props', JSON.stringify(pos))
    } else if (art.className.includes('br-css')) {
      localStorage.setItem('br.dialogPos.css', JSON.stringify(pos))
    } else if (art.className.includes('br-events')) {
      localStorage.setItem('br.dialogPos.events', JSON.stringify(pos))
    }  
  }

  render(null, dlg)
}
  
export const posDialog = (type) => {
  closeDialog()
  if (localStorage &amp;&amp; type) {
//localStorage.removeItem('br.dialogPos.props')
    let pos = {top: '60px', left: '200px'}
    switch (type) {
      case 'props':
        pos = localStorage.getItem('br.dialogPos.props') || {top: '100px', left: '700px'}
        break
      case 'css':
        pos = localStorage.getItem('br.dialogPos.css') || {top: '60px', left: '600px'}
        break
      default:
        pos = localStorage.getItem('br.dialogPos.events') || pos
    }
    if (typeof pos === 'string') {
      pos = JSON.parse(pos)
    }
    br.dlg.style.top = pos.top
    br.dlg.style.left = pos.left
  }
}





/* 
 *  List box
 */
export const ListBox = (props) => {
  let items = []
  props.data.forEach(r => {
    items.push(&lt;a id={r.id} class="list-item" onClick={props.onClick}>{r.text}&lt;/a>)
  })

  return (
    &lt;Dialog id={props.id} title={props.title}>
      &lt;div class="columns">
        &lt;div class="column">
          &lt;div class="list is-hoverable">
            {items}
          &lt;/div>
        &lt;/div>
      &lt;/div>
    &lt;/Dialog>
  )
}





/* 
 *  File from database
 */
export const fileFromDb = (par, cb) => {
  const onClick = (e) => {
    cb({id: e.target.id, filename: e.target.textContent})
    render(null, br.dlg)
  }
  
	const q = {cmd: 'GET', db: par.db || br.db, coll: 'fs.files'}
	if (par.type) q.where = {contentType: {$regex:'^'+par.type}}
  remote(q).then(res => {
		if (res.err) return
    let dat = []
    res.forEach(r => {
      dat.push({id: r._id, text: r.filename})
    });
  
    render(
      &lt;ListBox data={dat} title="File from database" onClick={onClick} />,
      br.dlg
    )
	})
}





/* 
 *  File upload
 */
export const fileUpload = (db, cb) => {
  const f = createElement('&lt;input type="file" style="display: none" />')
  $('body').append(f)
	
	f.addEventListener('change', (e) => {
    const file = f.files[0]
    let par = {cmd: 'FILE', mode: 'r', db: db, filename: file.name}
    remote(par).then(res => {
      if (res.err || res.lastModified !== file.lastModified) {
        par = Object.assign(par, {
          mode: 'w',
          options: {
            contentType: file.type,
            metadata: {
              lastModified: file.lastModified
            }
          }
        })
        remote(par, file, file.type).then(res => {
          res.filename = file.name
          f.remove()
          cb(res)
        })
      } else {
        res.filename = file.name
        cb(res)
      }
    })
	})
	
	f.click()
}




/* 
 *  Image load
 */
export const imgLoad = (db, img) => {
	if (db &amp;&amp; img) {
		const id = img.getAttribute('data-id')
		if (id) {
			const par = {cmd: 'FILE',	mode: 'r', db: db, _id: id, usercode: br.usercode}
			img.firstElementChild.setAttribute('src', '/brumba?' + JSON.stringify(par))
		}
	}
}



/**
 * Opens a modal dialog asking for confirmation
 * @method
 * @param {string} message - message to be displayed
 * @param {function} okHandler - ok button handler
 * @param {string} color - ok button color, default 'is-primary'
 */
export const confirmModal = (message, okHandler, color) => {
  const close = e => br.dlg.innerHTML = ''
  color = color || 'is-primary'
  
  render(null, br.dlg)
	br.dlg.innerHTML = `
		&lt;div class="modal is-active">
			&lt;div class="modal-background">&lt;/div>
			&lt;div class="modal-card">
				&lt;header class="modal-card-head">
					&lt;p class="modal-card-title">Confirmation needed&lt;/p>
					&lt;button class="delete" aria-label="close">&lt;/button>
				&lt;/header>
				&lt;section class="modal-card-body">
					${message}
				&lt;/section>
				&lt;footer class="modal-card-foot">
					&lt;button class="button ${color} mod-ok">Ok&lt;/button>
					&lt;button class="button mod-close">Cancel&lt;/button>
				&lt;/footer>
			&lt;/div>
		&lt;/div>
	`
	e$(br.dlg, '.mod-ok').addEventListener('click', e => {okHandler(); close()})
	e$(br.dlg, '.mod-close').addEventListener('click', close)
	e$(br.dlg, '.delete').addEventListener('click', close)
}






/* 
 *  Autocomplete
 */
export const autocomplete = (input, form) => {
	const auto = createElement(`
		&lt;div class="dropdown br-autocomplete is-active">
			&lt;div class="dropdown-trigger br-autocomplete">
			&lt;/div>
			&lt;div class="dropdown-menu" role="menu">
				&lt;div class="dropdown-content">
				&lt;/div>
			&lt;/div>
		&lt;/div>
	`)
	input.parentNode.replaceChild(auto, input)
	e$(auto, '.dropdown-trigger').append(input)
	const content = e$(auto, '.dropdown-content')
	content.style.display = 'none'

	input.addEventListener('change', e => {
		content.innerHTML = ''
		if (input.value.length > 2) {
			const query = toJSON(input.getAttribute('data-query'))
			const list = strSplit(input.getAttribute('data-list'), ',')
			if (query &amp;&amp; list) {
				if (!query.where) query.where = {}
				const regex = {
					'$regex': input.value,
					'$options': 'i'
				}
				if (list[1].charAt(0) === '+') {
					const fld0 = {}
					fld0[list[0]] = regex
					const fld1 = {}
					fld1[list[1].substring(1)] = regex
					query.where.$or = [fld0, fld1]
				} else {
					query.where[list[0]] = regex
				}
				query.limit = 100
				remote(query).then(res => {
					if (res.err) return
					if (res.length === 100) {
						notification(translate(`
							Too many records, only the first 100 returned. Please try to write more characters.
						`))
					}
					res.forEach(r => {
						const txt = listArgs(list, r)
						const a = createElement(`
							&lt;a id=${r._id} href="#" class="dropdown-item">${txt}&lt;/a>
						`)
						content.append(a)
						
						a.addEventListener('click', e => {
							content.style.display = 'none'
							const rec = res.find(r => r._id+'' === e.target.id+'')
							const fld = form.fields.find(f => f.name === input.getAttribute('name'))
							if (fld &amp;&amp; rec) {
								fld.newval = rec._id
								input.value = e.target.textContent
								if (query.extra) {
									extraFields(query.extra, rec, input)									
								}
							} else {
								alert(`fld: ${fld}  rec: ${rec}`)
							}
						})
					})
					content.style.display = 'block'
				})
			}
		} else {
			alert(translate('Minimum 3 characters please'))
		}
	})
	
	input.addEventListener('focusout', e => {
		if (!(e.relatedTarget &amp;&amp; e.relatedTarget.classList.contains('dropdown-item'))) {
			content.style.display = 'none'
		}
	})
	
}





/* 
 *  listArgs
 */
export const listArgs = (list, rec) => {
	let txt = rec[list[0]]
	const add = (sep, val) => txt += rec[val] ? sep + rec[val] : ''
	
	for (let i=1; i &lt; list.length; ++i) {
		if (list[i].charAt(0) === '+') {
			add(' ', list[i].substring(1))
		} else {
			add(' - ', list[i])
		}
	}
	return txt
}





/* 
 *  autocompleteText
 */
export const autocompleteText = async (input, form) => {
	const query = toJSON(input.getAttribute('data-query'))
	const fld = form.fields.find(f => f.name === input.getAttribute('name'))
	let rec = fld.data ? fld.data.find(r => r._id === form.data[fld.name]) : null
	// read data
	if (!fld.data || !rec) {
		const id = {_id: form.data[fld.name]}
		query.where = query.where ? Object.assign(query.where, id) : id
		const res = await remote(query)
		if (res.err) return
		if (!res[0]) return alert(translate('autocomplete _id not found '+input.value))
		if (fld.data) {
			fld.data.push(res[0])
			rec = res[0]
		} else {
			fld.data = res
			rec = fld.data.find(r => r._id === form.data[fld.name])
		}
	}
	if (rec) {
		input.value = listArgs(strSplit(input.getAttribute('data-list'), ','), rec)
		if (query.extra) {
			extraFields(query.extra, rec, input)
		}
	}
}




/* 
 *  extraFields
 */
const extraFields = (extraStr, rec, input) => {
	const formE = input.closest('form')
	const form = findForm(formE)
	const extra = strSplit(extraStr, ',')
	extra.forEach(f => {
		if (rec[f]) {
			e$(formE, `[name=${f}]`).value = rec[f]
			if (form.data) form.data[f] = rec[f]
		}
	})
}







/**
 * Display a notification 
 * @method
 * @param {string} message - message to be displayed
 */
export const notification = message => {
	const notif = createElement(`
		&lt;div class="notification is-danger">
			&lt;button class="delete">&lt;/button>
		&lt;/div>
	`)
	notif.append(createElement('&lt;p>'+message+'&lt;/p>'))
	e$(notif, 'button').addEventListener('click', e => notif.remove())
	$('body').append(notif)
}





/* 
 *  Tooltip
 */
export const tooltip = message => {
	const tt = createElement(`
		&lt;span class="tag is-dark">${message}&lt;/span>
	`)
	$('body').append(tt)
}





/* 
 *  Input image load
 */
export const inputImageLoad = (elem, id) => {
	if (id) {
		const par = {
			cmd: 'FILE',
			db: br.db,
			mode: 'r',
			_id: id,
			w: Math.round(elem.width),
			usercode: br.usercode
		}
		elem.setAttribute('src', '/brumba?' + JSON.stringify(par))
	}
}





/* 
 *  Input type file or image
 */
export const inputFile = (elem, image) => {
	elem.setAttribute('alt', ' ')
	
	// click
	elem.addEventListener('click', e => {
		openFile(elem.value, image ? elem.value : null)
	}, false)
	
	// right click
	elem.addEventListener('contextmenu', e => {
		e.preventDefault()
		fileUpload(br.db, res => {
			if (res.err) return alert('Cannot upload file')
			if (image) {
				const val = res.newid || res._id
				elem.value = val
				inputImageLoad(elem, val)
			} else {
				elem.value = res.filename
			}
			elem.dispatchEvent(new Event('change'))
		})        
	}, false)
}



/* 
 *  Open file
 */
export const openFile = (filename, id) => {
	const par = {
		cmd: 'FILE',
		db: br.db,
		mode: 'r',
		usercode: br.usercode
	}
	if (id) {
		par._id = id
	} else {
		par.filename = filename
	}
	window.open('/brumba?' + JSON.stringify(par))
}






/* 
 *  Context menu
 */
/*export const contextMenu = (input, options) => {
	const cm = createElement(`
		&lt;div class="dropdown br-contextmenu is-active">
			&lt;div class="dropdown-trigger">
			&lt;/div>
			&lt;div class="dropdown-menu" role="menu">
				&lt;div class="dropdown-content">
				&lt;/div>
			&lt;/div>
		&lt;/div>
	`)
	const parent = input.parentNode
	parent.replaceChild(cm, input)
	e$(cm, '.dropdown-trigger').append(input)
	
	
	const content = e$(cm, '.dropdown-content')
	content.style.display = 'none'

	content.innerHTML = ''
	options.forEach(o => {
		const a = createElement(`
			&lt;a class="dropdown-item">${o.title}&lt;/a>
		`)
		a.onclick = o.fn
		content.append(a)
	})
	content.style.display = 'block'
	
	
	
}

const contextMenuClose = e => {
console.log('contextMenuClose')
	const cm = $('.br-contextmenu')
	if (cm) {
		const input = e$(cm, 'input')
		if (input) {
			cm.parentNode.replaceChild(input, cm)
		}
	}
}

$('body').addEventListener('click', contextMenuClose)
*/
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#$">$</a></li><li><a href="global.html#$$">$$</a></li><li><a href="global.html#br">br</a></li><li><a href="global.html#childIndex">childIndex</a></li><li><a href="global.html#clientScript">clientScript</a></li><li><a href="global.html#confirmModal">confirmModal</a></li><li><a href="global.html#createElement">createElement</a></li><li><a href="global.html#dateFormat">dateFormat</a></li><li><a href="global.html#e$">e$</a></li><li><a href="global.html#e$$">e$$</a></li><li><a href="global.html#err">err</a></li><li><a href="global.html#findForm">findForm</a></li><li><a href="global.html#formInput">formInput</a></li><li><a href="global.html#formRetrieve">formRetrieve</a></li><li><a href="global.html#formSave">formSave</a></li><li><a href="global.html#formUpdate">formUpdate</a></li><li><a href="global.html#gridRender">gridRender</a></li><li><a href="global.html#hex24">hex24</a></li><li><a href="global.html#inputDate">inputDate</a></li><li><a href="global.html#n$$">n$$</a></li><li><a href="global.html#notification">notification</a></li><li><a href="global.html#objClone">objClone</a></li><li><a href="global.html#objDel">objDel</a></li><li><a href="global.html#objEmpty">objEmpty</a></li><li><a href="global.html#objLess">objLess</a></li><li><a href="global.html#objPick">objPick</a></li><li><a href="global.html#remote">remote</a></li><li><a href="global.html#report">report</a></li><li><a href="global.html#strCap">strCap</a></li><li><a href="global.html#strFindAny">strFindAny</a></li><li><a href="global.html#strGetBet">strGetBet</a></li><li><a href="global.html#strSplit">strSplit</a></li><li><a href="global.html#timezone">timezone</a></li><li><a href="global.html#toJSON">toJSON</a></li><li><a href="global.html#translate">translate</a></li><li><a href="global.html#validate">validate</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Thu Aug 20 2020 19:32:28 GMT+0300 (Eastern European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
